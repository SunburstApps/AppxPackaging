<Project>
  <PropertyGroup>
    <AppxPackageRoot Condition="'$(AppxPackageRoot)' == ''">$(OutputPath)\AppX\</AppxPackageRoot>
    <AppxPackageLayoutDir Condition="'$(AppxPackageLayoutDir)' == ''">$(AppxPackageRoot)Layout</AppxPackageLayoutDir>

    <CreateAppXPackageOnBuild Condition="'$(CreateAppXPackageOnBuild)' == ''">false</CreateAppXPackageOnBuild>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(AppxBuildTasksAssembly)" TaskName="Sunburst.AppxPackaging.BuildTasks.CreatePriConfig" />
  <UsingTask AssemblyFile="$(AppxBuildTasksAssembly)" TaskName="Sunburst.AppxPackaging.BuildTasks.CompilePriConfig" />

  <Target Name="AppxCheckPreconditions">
    <Error Text="An AppxManifest item must be specified." Condition="'@(AppxManifest)' == ''" />
    <Error Text="Only one AppxManifest item may be specified (there are @(AppxManifest -> Count()))." Condition="'@(AppxManifest -> Count())' != '1'" />
    <Error Text="You must specify the AppXDestination property if IncludeBuildOutputInAppXPackage is true" Condition="'$(IncludeBuildOutputInAppXPackage)' == 'true' and '$(AppXDestination)' == ''" />

    <PropertyGroup>
      <AppxPackageRoot Condition="!HasTrailingSlash($(AppxPackageRoot))">$(AppxPackageRoot)\</AppxPackageRoot>
      <AppxPackageLayoutDir Condition="!HasTrailingSlash($(AppxPackageLayoutDir))">$(AppxPackageLayoutDir)\</AppxPackageLayoutDir>
    </PropertyGroup>
  </Target>

  <Target Name="AppxCreatePackageLayout" DependsOnTargets="AppxCheckPreconditions">
    <MakeDir Directories="$(AppxPackageLayoutDir)" />

    <!-- Build the project references. -->
    <ItemGroup Condition="'$(IncludeBuildOutputInAppXPackage)' == 'true' and '$(AppXDestination)' != ''">
      <_ProjectReferenceWithDestination Include="$(MSBuildProjectFullPath)">
        <Destination>$(AppXDestination)</Destination>
      </_ProjectReferenceWithDestination>
    </ItemGroup>
    <ItemGroup>
      <_ProjectReferenceWithDestination Include="@(ProjectReference)" Condition="'%(ProjectReference.Destination)' != ''">
        <Destination>%(ProjectReference.Destination)</Destination>
      </_ProjectReferenceWithDestination>
    </ItemGroup>

    <MSBuild Projects="@(_ProjectReferenceWithDestination)" Targets="_AppXPackageGetProjectFiles" Properties="_AppXDestination=%(Destination)">
      <Output TaskParameter="TargetOutputs" ItemName="_ProjectFileWithDuplicates" />
    </MSBuild>

    <RemoveDuplicates Inputs="@(_ProjectFileWithDuplicates)">
      <Output TaskParameter="Filtered" ItemName="_ProjectFile" />
    </RemoveDuplicates>

    <!-- Don't copy the PDBs, these should not be shipped. -->
    <ItemGroup>
      <_ProjectFile Remove="@(_ProjectFile)" Condition="'%(Extension)' == '.pdb'" />
    </ItemGroup>

    <!-- Add the content files. -->
    <ItemGroup>
      <Content Include="@(AppxVisualAsset)">
        <CopyToAppX>true</CopyToAppX>
        <DestinationFile>Assets/%(FileName)%(Extension)</DestinationFile>
      </Content>

      <Content Include="@(_ProjectFile)">
        <CopyToAppX>true</CopyToAppX>
        <Destination>%(Destination)</Destination>
      </Content>
    </ItemGroup>

    <!-- Copy the content files. -->
    <ItemGroup>
      <_ContentWithDestinationFile Include="@(Content)" Condition="'%(Content.CopyToAppX)' == 'true' and '%(Content.Destination)' != '' and '%(Content.DestinationFile)' == ''">
        <DestinationFile>$(AppxPackageLayoutDir)\%(Destination)\%(FileName)%(Extension)</DestinationFile>
      </_ContentWithDestinationFile>
      <_ContentWithDestinationFile Include="@(Content)" Condition="'%(Content.CopyToAppX)' == 'true' and '%(Content.DestinationFile)' != ''">
        <DestinationFile>$(AppxPackageLayoutDir)\%(DestinationFile)</DestinationFile>
      </_ContentWithDestinationFile>
    </ItemGroup>
    <Copy SourceFiles="@(_ContentWithDestinationFile)" DestinationFiles="%(DestinationFile)" />

    <!-- Copy the AppX manifest. -->
    <Copy SourceFiles="@(AppxManifest)" DestinationFolder="$(AppxPackageLayoutDir)" />
  </Target>

  <Target Name="AppxCreatePriConfig" DependsOnTargets="AppxCheckPreconditions">
    <PropertyGroup>
      <AppxPriLanguages Condition="'$(AppxPriLanguages)' == ''">en-US</AppxPriLanguages>
    </PropertyGroup>

    <MakeDir Directories="$(AppxPackageRoot)Fat" Condition="!Exists('$(AppxPackageRoot)Fat')" />
    <CreatePriConfig LanguageQualifiers="$(AppxPriLanguages)" TargetVersion="$(AppxPriTargetVersion)" ConfigFilePath="$(AppxPackageRoot)FatPackage.xml"
                     StandardOutputImportance="normal" StandardErrorImportance="high" />
  </Target>

  <Target Name="AppxCompilePriConfig" DependsOnTargets="AppxCheckPreconditions; AppxCreatePriConfig">
    <CompilePriConfig PackageLayout="$(AppxPackageLayoutDir)" ConfigFile="$(AppxPackageRoot)FatPackage.xml" OutputFile="$(AppxPackageLayoutDir)resources.pri"
                      StandardOutputImportance="normal" StandardErrorImportance="high" />
  </Target>

  <Target Name="MakeAppxLayout" DependsOnTargets="AppxCreatePackageLayout; AppxCompilePriConfig" />
  <Target Name="CreateAppXLayoutOnBuild" DependsOnTargets="MakeAppxLayout" Condition="'$(CreateAppXLayoutOnBuild)' == 'true'" />
</Project>
